<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gig Details — Talent-Hub</title>  <!-- Fonts & Icons -->  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>  <style>
    :root {
      --bg: #071018; 
      --panel: #0b1720; 
      --muted: #9fb0bd; 
      --accent1: #06d6a0; 
      --accent2: #3b82f6;
      --accent3: #f59e0b;
      --card: linear-gradient(180deg,#071a12,#071827);
      --card-hover: linear-gradient(180deg, #082a1e, #082232);
      --transition: all 0.3s ease;
    }
    * { box-sizing: border-box; margin:0; padding:0 }
    body { min-height:100vh; background: linear-gradient(180deg,#050b10,#071018); color:#e6f8f1; font-family:'Poppins',system-ui,Roboto,Arial; }
    .container { max-width:1280px; margin:0 auto; padding:20px }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; padding-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05) }
    .brand { font-weight:800; color:var(--accent1); font-size:24px; display:flex; gap:10px; align-items:center }
    .card { background:var(--panel); border-radius:16px; padding:24px; border:1px solid rgba(255,255,255,0.04); box-shadow:0 12px 30px rgba(4,8,12,0.6); transition:var(--transition) }
    .top { display:grid; grid-template-columns:1fr 360px; gap:24px; margin-bottom:30px }
    @media (max-width:1080px){ .top{ grid-template-columns:1fr } .side-card{ position:static !important; margin-top:20px } }
    .gallery{ display:flex; flex-direction:column; gap:12px; position:relative }
    .main-image{ height:420px; border-radius:12px; background-size:cover; background-position:center; box-shadow:0 12px 34px rgba(3,8,12,0.6); cursor:zoom-in; transition:var(--transition) }
    .thumbs{ display:flex; gap:10px; flex-wrap:wrap }
    .thumb{ width:80px; height:80px; border-radius:10px; background-size:cover; background-position:center; border:2px solid transparent; cursor:pointer; transition:var(--transition) }
    .thumb:hover{ transform:scale(1.05); border-color:var(--accent1) }
    .thumb.active{ border-color:var(--accent1); box-shadow:0 0 0 3px rgba(6,214,160,0.2) }
    .title{ font-size:28px; font-weight:800; color:#fff; margin-bottom:10px; line-height:1.3 }
    .seller-row{ display:flex; gap:12px; align-items:center; margin-bottom:15px }
    .seller-avatar{ width:56px; height:56px; border-radius:12px; display:grid; place-items:center; font-weight:800; color:white; background:linear-gradient(135deg,#0ea5a0,#2563eb); font-size:20px; flex-shrink:0 }
    .muted{ color:var(--muted) }
    .price-box{ margin-top:15px; padding:16px; border-radius:12px; background:linear-gradient(180deg,#04221a,#052a20); display:flex; justify-content:space-between; align-items:center; border:1px solid rgba(6,214,160,0.1) }
    .price{ font-weight:900; font-size:24px; color:var(--accent2) }
    .delivery{ font-size:14px; color:var(--muted) }
    .desc{ margin-top:15px; color:#cfeee6; line-height:1.7; font-size:16px }
    .features{ display:flex; gap:12px; flex-wrap:wrap; margin-top:15px }
    .chip{ padding:8px 14px; border-radius:999px; background:rgba(255,255,255,0.04); color:var(--muted); font-weight:600; font-size:14px; border:1px solid rgba(255,255,255,0.03); transition:var(--transition) }
    .chip:hover{ background:rgba(6,214,160,0.1); color:var(--accent1) }
    .side-card{ position:sticky; top:90px; height:fit-content }
    .side-price{ display:flex; justify-content:space-between; align-items:center; gap:10px }
    .side-actions{ display:flex; gap:10px; margin-top:15px; flex-wrap:wrap }
    .btn{ padding:12px 18px; border-radius:12px; border:0; cursor:pointer; font-weight:700; font-size:16px; transition:var(--transition); display:flex; align-items:center; gap:8px }
    .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.08); color:#d8efe6 }
    .btn-primary{ background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#042617; flex:1; justify-content:center }
    .fav{ width:50px; height:50px; border-radius:12px; background:transparent; border:1px dashed rgba(255,255,255,0.08); display:grid; place-items:center; cursor:pointer }
    .top-like-btn{ position:absolute; top:15px; right:15px; width:48px; height:48px; border-radius:12px; background:rgba(0,0,0,0.5); display:grid; place-items:center; color:#fff; border:0; cursor:pointer; z-index:2 }
    .top-like-btn.liked{ background:linear-gradient(90deg,#10b981,#2dd4bf); color:#042617 }
    .tabs{ display:flex; gap:10px; margin-top:20px; border-bottom:1px solid rgba(255,255,255,0.04); padding-bottom:12px }
    .tab{ padding:10px 16px; border-radius:10px; font-weight:600; color:var(--muted); cursor:pointer }
    .tab.active{ background:rgba(6,182,212,0.1); color:#cfeee6 }
    .review{ display:flex; gap:15px; padding:16px; border-radius:12px; background:#071a18; border:1px solid rgba(255,255,255,0.03); margin-bottom:12px }
    .similar-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:15px; margin-top:15px }
    .small{ font-size:13px; color:var(--muted) }
    footer{ margin-top:30px; text-align:center; color:var(--muted); font-size:14px; padding:20px 0; border-top:1px solid rgba(255,255,255,0.04) }
    .packages{ display:grid; grid-template-columns:repeat(3,1fr); gap:15px; margin-top:20px }
    @media (max-width:768px){ .packages{ grid-template-columns:1fr } }
    .package{ background:linear-gradient(180deg,#0a1e24,#071a22); border-radius:12px; padding:20px; border:1px solid rgba(255,255,255,0.04); position:relative }
    .package.popular{ border:2px solid var(--accent1); transform:scale(1.02) }
    .package::before{ content:'' }
    .lightbox{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(7,16,24,0.95); display:flex; align-items:center; justify-content:center; z-index:1000; opacity:0; pointer-events:none; transition:opacity 0.3s ease }
    .lightbox.active{ opacity:1; pointer-events:all }
    .lightbox-img{ max-width:100%; max-height:90vh; border-radius:8px; box-shadow:0 20px 50px rgba(0,0,0,0.5) }
    .faq-item{ margin-bottom:15px; border:1px solid rgba(255,255,255,0.05); border-radius:12px; overflow:hidden }
    .faq-question{ padding:16px; background:rgba(255,255,255,0.02); cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-weight:600 }
    .faq-answer{ padding:0 16px; max-height:0; overflow:hidden; transition:max-height 0.3s ease, padding 0.3s ease }
    .faq-item.active .faq-answer{ max-height:300px; padding:16px }
    .floating-order{ position:fixed; bottom:0; left:0; width:100%; background:var(--panel); padding:15px 0; border-top:1px solid rgba(255,255,255,0.05); display:none; z-index:999 }
    .loading-spinner{ display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,0.3); border-radius:50%; border-top-color:var(--accent1); animation:spin 1s ease-in-out infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .toast{ position:fixed; bottom:20px; right:20px; padding:12px 20px; background:var(--panel); color:white; border-radius:8px; box-shadow:0 5px 15px rgba(0,0,0,0.2); display:flex; align-items:center; gap:10px; z-index:1000; transform:translateY(100px); opacity:0; transition:transform 0.3s ease, opacity 0.3s ease }
    .toast.show{ transform:translateY(0); opacity:1 }
    .toast.success{ border-left:4px solid var(--accent1) }
    .toast.error{ border-left:4px solid #ef4444 }
    .review-form{ margin-top:20px; padding:20px; border-radius:12px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03) }
    .star-rating{ display:flex; gap:5px; margin-bottom:15px }
    .star{ font-size:24px; color:#4b5563; cursor:pointer }
    .star.active{ color:#f59e0b }
    .stats{ display:flex; gap:20px; margin:20px 0; flex-wrap:wrap }
    .stat-item{ display:flex; align-items:center; gap:10px; padding:10px 15px; background:rgba(255,255,255,0.02); border-radius:10px; border:1px solid rgba(255,255,255,0.03) }
    .mobile-order-bar{ display:none }
    @media (max-width:768px){ .mobile-order-bar{ display:flex; position:fixed; bottom:0; left:0; width:100%; background:var(--panel); padding:15px; border-top:1px solid rgba(255,255,255,0.05); z-index:999; justify-content:space-between; align-items:center } .side-card{ display:none } }
  </style></head>
<body>
  <div class="container">
    <header>
      <div class="brand"><i class="fas fa-rocket"></i> Talent-Hub</div>
      <div id="loginStatus" class="small">Checking auth…</div>
    </header><main class="card">
  <div class="top">
    <div>
      <div class="gallery card" style="padding:16px; position:relative">
        <div id="mainImage" class="main-image" style="background-image:url('https://via.placeholder.com/1200x800.png?text=Loading...')"></div>
        <button id="topLikeBtn" class="top-like-btn" title="Like"><i class="far fa-heart"></i></button>
        <div id="thumbs" class="thumbs" style="margin-top:12px"></div>

        <div style="margin-top:18px">
          <div id="gigTitle" class="title">Loading title…</div>
          <div class="seller-row">
            <div id="sellerAvatar" class="seller-avatar">S</div>
            <div>
              <div style="display:flex;align-items:center;gap:8px"><a id="sellerProfileLink" href="#" style="color:inherit;text-decoration:none;font-weight:800" id="panelSellerName">Seller</a><span id="panelSellerRole" class="muted small"></span></div>
              <div id="sellerBio" class="small muted"></div>
            </div>
          </div>

          <div id="createdAt" class="small muted"></div>
          <div id="desc" class="desc" style="margin-top:12px"></div>

          <div class="features" id="features" style="margin-top:12px"></div>

          <div style="margin-top:20px">
            <div class="tabs">
              <div class="tab active" data-tab="details">Details</div>
              <div class="tab" data-tab="reviews">Reviews</div>
              <div class="tab" data-tab="faq">FAQ</div>
              <div class="tab" data-tab="similar">Similar</div>
            </div>

            <div id="detailsTab" style="margin-top:18px">
              <div class="card" style="padding:16px">
                <div class="small muted">What you'll get</div>
                <div id="whatYouGet" style="margin-top:8px"></div>

                <div class="packages" id="packages"></div>

                <div style="margin-top:20px">
                  <h4 style="margin-bottom:10px">Addons</h4>
                  <div id="addons" style="display:flex;flex-wrap:wrap;gap:10px"></div>
                </div>

                <div style="margin-top:20px">
                  <h4 style="margin-bottom:10px">Skills</h4>
                  <div id="skillsWrap" style="display:flex;gap:8px;flex-wrap:wrap"></div>
                </div>

              </div>
            </div>

            <div id="reviewsTab" class="hidden" style="margin-top:18px">
              <div class="card" style="padding:16px">
                <div id="reviewsList"></div>

                <div class="review-form">
                  <div class="star-rating" id="starRating">
                    <span class="star" data-value="1">☆</span>
                    <span class="star" data-value="2">☆</span>
                    <span class="star" data-value="3">☆</span>
                    <span class="star" data-value="4">☆</span>
                    <span class="star" data-value="5">☆</span>
                  </div>
                  <textarea id="reviewText" rows="3" style="width:100%;border-radius:8px;padding:10px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit" placeholder="Write your review..."></textarea>
                  <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
                    <button id="addReviewBtn" class="btn btn-primary">Post Review</button>
                    <div id="reviewStatus" class="small muted"></div>
                  </div>
                </div>
              </div>
            </div>

            <div id="faqTab" class="hidden" style="margin-top:18px">
              <div id="faqList"></div>
            </div>

            <div id="similarTab" class="hidden" style="margin-top:18px">
              <div id="similarGrid"></div>
            </div>

          </div>

        </div>

      </div>
    </div>

    <aside class="side-card">
      <div class="card" style="padding:16px">
        <div class="side-price">
          <div>
            <div class="small muted">Price</div>
            <div id="price" class="price">₹0</div>
            <div id="delivery" class="delivery">Delivery info</div>
          </div>
          <div style="text-align:right">
            <div id="likeArea" class="small muted">0 Likes</div>
            <button id="favBtn" class="fav" title="Favorite"><i id="favIcon" class="fa-regular fa-heart"></i></button>
          </div>
        </div>

        <div class="side-actions">
          <button id="continueBtn" class="btn btn-primary">Continue</button>
          <button id="contactBtn" class="btn btn-ghost">Contact</button>
        </div>

        <div style="margin-top:16px">
          <div class="stats">
            <div class="stat-item"><div class="stat-icon"><i class="fas fa-clock"></i></div><div><div class="small muted">Delivery</div><div id="sideDelivery">3 days</div></div></div>
            <div class="stat-item"><div class="stat-icon"><i class="fas fa-star"></i></div><div><div class="small muted">Rating</div><div id="ratingVal">0</div></div></div>
          </div>
        </div>

        <div style="margin-top:18px">
          <h4 class="small muted">Seller</h4>
          <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
            <img id="sellerPhoto" src="" alt="seller" style="width:56px;height:56px;border-radius:12px;object-fit:cover"/>
            <div>
              <div id="sellerName" style="font-weight:800">Seller</div>
              <div id="sellerSince" class="small muted"></div>
            </div>
          </div>
        </div>

      </div>
    </aside>

  </div>

  <div class="floating-order" id="floatingOrder">
    <div class="floating-order-content">
      <div>
        <div class="small muted">Selected</div>
        <div id="floatingPrice" style="font-weight:800">₹0</div>
      </div>
      <div class="floating-order-actions">
        <button class="btn btn-primary">Buy Now</button>
        <button class="btn btn-ghost">Message Seller</button>
      </div>
    </div>
  </div>

</main>

<footer>© Talent-Hub</footer>

  </div>  <!-- Lightbox for images -->  <div class="lightbox" id="lightbox">
    <div class="lightbox-content">
      <img class="lightbox-img" id="lightboxImg" src="" alt="">
      <button class="lightbox-close" id="lightboxClose"><i class="fas fa-times"></i></button>
    </div>
    <div class="lightbox-nav">
      <button class="lightbox-btn" id="lightboxPrev"><i class="fas fa-chevron-left"></i></button>
      <button class="lightbox-btn" id="lightboxNext"><i class="fas fa-chevron-right"></i></button>
    </div>
  </div>  <!-- Toast -->  <div class="toast" id="toast"><i class="fas fa-check-circle"></i><div id="toastMessage">Operation completed</div></div>  <!-- FIREBASE (modular v10) -->  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, collection, query, where, orderBy, limit,
      onSnapshot, getDoc, getDocs, addDoc, serverTimestamp, runTransaction, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase config (keep your own project credentials here)
    const firebaseConfig = {
      apiKey: "AIzaSyBxNGIBexYUb-LecKJRgxPNsY5ZFN1_zUA",
      authDomain: "skillspot-pro.firebaseapp.com",
      projectId: "skillspot-pro",
      storageBucket: "skillspot-pro.appspot.com",
      messagingSenderId: "600467343030",
      appId: "1:600467343030:web:ad985d8e95b3ea99c64817"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // helpers
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const GIG_ID = new URL(location).searchParams.get('id');
    if (!GIG_ID) {
      document.querySelector('.container').innerHTML = '<div class="card">Open this page with ?id=GIG_ID</div>';
      throw new Error('Missing id');
    }

    // Elements
    const mainImage = $('#mainImage'), thumbs = $('#thumbs');
    const gigTitle = $('#gigTitle'), descEl = $('#desc'), longDesc = $('#longDesc');
    const priceEl = $('#price'), sidePrice = $('#floatingPrice'), deliveryEl = $('#delivery'), sideDelivery = $('#sideDelivery');
    const featuresWrap = $('#features'), skillsWrap = $('#skillsWrap'), whatYouGet = $('#whatYouGet');
    const sellerAvatar = $('#sellerAvatar'), sellerName = $('#sellerName'), sellerBio = $('#sellerBio'), sellerSince = $('#sellerSince');
    const sellerPhoto = $('#sellerPhoto'), panelSellerName = $('#panelSellerName'), sellerProfileLink = $('#sellerProfileLink'), panelSellerRole = $('#panelSellerRole');
    const likeArea = $('#likeArea'), favBtn = $('#favBtn'), favIcon = $('#favIcon'), topLikeBtn = $('#topLikeBtn');
    const continueBtn = $('#continueBtn'), contactBtn = $('#contactBtn'), loginStatus = $('#loginStatus');
    const reviewsList = $('#reviewsList'), addReviewBtn = $('#addReviewBtn'), reviewText = $('#reviewText'), reviewStatus = $('#reviewStatus');
    const similarGrid = $('#similarGrid');
    const packagesContainer = $('#packages');
    const faqList = $('#faqList');
    const lightbox = $('#lightbox');
    const lightboxImg = $('#lightboxImg');
    const lightboxClose = $('#lightboxClose');
    const lightboxPrev = $('#lightboxPrev');
    const lightboxNext = $('#lightboxNext');
    const toast = $('#toast');
    const toastMessage = $('#toastMessage');
    const stars = $$('.star');

    // constants for collections
    const GIGS_COL = 'subho_gigs';
    const USERS_COL = 'users';
    const GIG_LIKES_USER = 'gig_likes_user';
    const GIG_LIKES_AGG = 'gig_likes_agg';
    const GIG_LIKES_RAW = 'gig_likes';
    const REVIEWS_COL = 'gig_reviews';

    // state
    let currentUser = null;
    let gigData = null;
    let currentImages = [];
    let currentImageIndex = 0;
    let aggUnsub = null;
    let reviewsUnsub = null;
    let similarUnsub = null;
    let sellerUnsub = null;
    let selectedRating = 5;

    // util
    const escapeImg = u => String(u||'').replaceAll("'","%27");

    function setGallery(urls=[]) {
      if (!Array.isArray(urls) || urls.length===0) urls = ['https://via.placeholder.com/1200x800.png?text=Talent-Hub+Gig'];
      currentImages = urls;
      mainImage.style.backgroundImage = `url('${escapeImg(urls[0])}')`;
      thumbs.innerHTML = '';
      urls.forEach((u,i)=>{
        const t = document.createElement('div');
        t.className = 'thumb' + (i===0?' active':'');
        t.style.backgroundImage = `url('${escapeImg(u)}')`;
        t.dataset.index = i;
        t.addEventListener('click', ()=>{ $$(`.thumb`).forEach(x=>x.classList.remove('active')); t.classList.add('active'); mainImage.style.backgroundImage = `url('${escapeImg(u)}')`; currentImageIndex = i; });
        thumbs.appendChild(t);
      });
    }

    // Lightbox functionality
    mainImage.addEventListener('click', () => { lightbox.classList.add('active'); lightboxImg.src = currentImages[currentImageIndex] || ''; });
    lightboxClose.addEventListener('click', () => { lightbox.classList.remove('active'); });
    lightboxPrev.addEventListener('click', () => { currentImageIndex = currentImageIndex > 0 ? currentImageIndex - 1 : currentImages.length - 1; lightboxImg.src = currentImages[currentImageIndex]; });
    lightboxNext.addEventListener('click', () => { currentImageIndex = currentImageIndex < currentImages.length - 1 ? currentImageIndex + 1 : 0; lightboxImg.src = currentImages[currentImageIndex]; });

    // Stars
    stars.forEach(star => {
      star.addEventListener('click', () => {
        const value = parseInt(star.dataset.value);
        selectedRating = value;
        stars.forEach(s => {
          const v = parseInt(s.dataset.value);
          if (v <= value) { s.textContent = '★'; s.classList.add('active'); } else { s.textContent = '☆'; s.classList.remove('active'); }
        });
      });
      if (parseInt(star.dataset.value) <= 5) { star.textContent = '★'; star.classList.add('active'); }
    });

    function showToast(message, type = 'success') {
      toastMessage.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 3000);
    }

    // render gig
    function renderGig(g) {
      // Title with small label
      const titleLabel = (g.titleLabel || 'Title');
      gigTitle.innerHTML = `<div style="font-size:12px;color:var(--muted);font-weight:600;margin-bottom:6px">${titleLabel}</div><div style="font-size:22px">${g.title || 'Untitled'}</div>`;

      // Description with read-more / expand
      const fullDesc = g.description || g.short || '';
      setDescription(fullDesc);

      priceEl.textContent = '₹' + (g.price || 0);
      sidePrice.textContent = '₹' + (g.price || 0);
      deliveryEl.textContent = g.delivery ? g.delivery + ' days delivery' : (g.delivery || '3 days delivery');
      sideDelivery.textContent = 'Delivery: ' + (g.delivery || '3 days');
      whatYouGet.textContent = g.whatYouGet || g.packageDescription || '';

      // features
      featuresWrap.innerHTML = '';
      (g.features || g.styles || []).forEach(f=>{ const d = document.createElement('div'); d.className='chip'; d.textContent = f; featuresWrap.appendChild(d); });

      // skills (show a small heading and then chips)
      skillsWrap.innerHTML = '';
      const primarySkills = (g.primarySkills || []);
      if (primarySkills.length) {
        const h = document.createElement('div'); h.className='small muted'; h.style.marginBottom='6px'; h.textContent = 'Primary skills'; skillsWrap.appendChild(h);
      }
      (g.skills||[]).forEach(s=>{ const sp = document.createElement('div'); sp.className='chip'; sp.textContent = s; skillsWrap.appendChild(sp); });

      const createdAt = g.createdAt ? (g.createdAt.toDate ? g.createdAt.toDate().toLocaleDateString() : new Date(g.createdAt).toLocaleDateString()) : '';
      $('#createdAt').textContent = createdAt ? 'Posted ' + createdAt : '';

      // seller (show seller name near main image and full profile on right)
      panelSellerName.textContent = g.sellerName || g.seller || 'Seller';
      panelSellerRole.textContent = g.sellerRole || '';
      sellerBio.textContent = g.sellerBio || '';
      sellerSince.textContent = g.sellerSince ? '• Since ' + g.sellerSince : '';

      // set left-side seller avatar (large full photo if available)
      if (g.coverURL || (Array.isArray(g.images) && g.images[0])) {
        const leftImg = (Array.isArray(g.images) && g.images[0]) || g.coverURL;
        mainImage.style.backgroundImage = `url('${escapeImg(leftImg)}')`;
      }

      // also set seller photo on right side
      sellerPhoto.src = g.sellerPhoto || g.photoURL || '';
      sellerName.textContent = g.sellerName || g.seller || 'Seller';

      // gallery images
      const images = Array.isArray(g.images) && g.images.length ? g.images : (g.coverURL ? [g.coverURL] : []);
      setGallery(images);

      // packages
      renderPackages(g.packages || {});

      // addons
      renderAddons(g.addons || []);
    }

    // description helper: show truncated text with read more toggle
    function setDescription(fullText) {
      const maxChars = 320; // approx 2-3 lines depending on screen
      const descEl = document.getElementById('desc');
      descEl.innerHTML = '';
      if (!fullText) { descEl.textContent = ''; return; }
      if (fullText.length <= maxChars) { descEl.textContent = fullText; return; }
      const short = fullText.slice(0, maxChars) + '...';
      const p = document.createElement('div'); p.textContent = short; p.style.whiteSpace='pre-wrap'; p.style.lineHeight='1.6';
      const more = document.createElement('a'); more.href='#'; more.textContent = ' Read more'; more.style.marginLeft='6px'; more.className='small muted';
      let expanded = false;
      more.addEventListener('click', (ev)=>{
        ev.preventDefault();
        if (!expanded) { p.textContent = fullText; more.textContent = ' Read less'; expanded = true; }
        else { p.textContent = short; more.textContent = ' Read more'; expanded = false; }
      });
      descEl.appendChild(p); descEl.appendChild(more);
    }

    function renderPackages(pkgs) {
      packagesContainer.innerHTML = '';
      // Firestore might store as object with named packages or array
      const list = Array.isArray(pkgs) ? pkgs : Object.keys(pkgs||{}).map(k=>({ key:k, ...(pkgs[k]||{}) }));
      if (!list || list.length===0) { packagesContainer.innerHTML = '<div class="muted">No packages available</div>'; return; }
      list.forEach(p=>{
        const el = document.createElement('div'); el.className = 'package ' + ((p.popular||p.name==='Standard')? 'popular':'');
        const features = (p.features || []).map(f=>`<li><i class="fas fa-check"></i> ${f}</li>`).join('');
        el.innerHTML = `<div class="package-header"><div class="package-name">${p.name||p.key||'Package'}</div><div class="package-desc">${p.description||''}</div></div>
          <div class="package-price">₹${p.price||0}</div>
          <ul class="package-features">${features}</ul>
          <button class="btn btn-primary package-btn" data-price="${p.price||0}" data-name="${(p.name||p.key||'Package').replace(/"/g,'')}">Select Package</button>`;
        packagesContainer.appendChild(el);
      });

      // attach click handlers
      $$('.package-btn').forEach(b=>b.addEventListener('click', ()=>{ const price = b.dataset.price||0; sidePrice.textContent = '₹'+price; $('#floatingPrice').textContent = '₹'+price; showToast('Package selected: '+b.dataset.name); }));
    }

    function renderAddons(addons) {
      const wrap = $('#addons'); wrap.innerHTML = '';
      if (!Array.isArray(addons) || addons.length===0) { wrap.innerHTML = '<div class="muted">No addons</div>'; return; }
      addons.forEach(a=>{
        const b = document.createElement('button'); b.className='chip btn-ghost'; b.textContent = `${a.name||a.title||'Addon'} (+₹${a.price||0})`;
        b.addEventListener('click', ()=>{ showToast('Addon toggled: '+(a.name||a.title||'Addon')); });
        wrap.appendChild(b);
      });
    }

    // -------------------- Likes --------------------
    const aggDocRef = (gid) => doc(db, GIG_LIKES_AGG, gid);
    const userLikeDoc = (uid, gid) => doc(db, GIG_LIKES_USER, `${uid}_${gid}`);
    const rawLikeDoc = (uid, gid) => doc(db, GIG_LIKES_RAW, `${gid}_${uid}`);

    function watchLikes(gid) {
      if (aggUnsub) aggUnsub();
      const aRef = aggDocRef(gid);
      aggUnsub = onSnapshot(aRef, s=>{
        const c = s.exists() ? (s.data().count||0) : 0;
        likeArea.textContent = `${c} Like${c===1?'':'s'}`;
      }, err=>{ console.warn('agg watch err', err); });
      refreshUserLikeState();
    }

    async function refreshUserLikeState() {
      if (!currentUser) { favBtn.classList.remove('liked'); favIcon.className='fa-regular fa-heart'; topLikeBtn.innerHTML = '<i class="far fa-heart"></i>'; topLikeBtn.classList.remove('liked'); return; }
      try {
        const s = await getDoc(userLikeDoc(currentUser.uid, GIG_ID));
        if (s.exists()) { favBtn.classList.add('liked'); favIcon.className='fa-solid fa-heart'; topLikeBtn.innerHTML = '<i class="fas fa-heart"></i>'; topLikeBtn.classList.add('liked'); }
        else { favBtn.classList.remove('liked'); favIcon.className='fa-regular fa-heart'; topLikeBtn.innerHTML = '<i class="far fa-heart"></i>'; topLikeBtn.classList.remove('liked'); }
      } catch(e){ console.warn(e); }
    }

    const handleLike = async (e)=>{
      if (e) e.stopPropagation();
      if (!currentUser) { if (confirm('Login required to like. Go to login?')) window.location = 'login.html'; return; }
      favBtn.disabled = true;
      try {
        await runTransaction(db, async (t)=>{
          const uRef = userLikeDoc(currentUser.uid, GIG_ID);
          const rRef = rawLikeDoc(currentUser.uid, GIG_ID);
          const aRef = aggDocRef(GIG_ID);
          const uSnap = await t.get(uRef);
          const aSnap = await t.get(aRef);
          let count = aSnap.exists() ? (aSnap.data().count||0) : 0;
          if (uSnap.exists()) {
            t.delete(uRef); t.delete(rRef); count = Math.max(0, count - 1); t.set(aRef, { count }, { merge:true }); showToast('Removed from your favorites');
          } else {
            t.set(uRef, { uid: currentUser.uid, gid: GIG_ID, createdAt: serverTimestamp() });
            t.set(rRef, { uid: currentUser.uid, gid: GIG_ID, createdAt: serverTimestamp() });
            count = count + 1; t.set(aRef, { count }, { merge:true }); showToast('Added to your favorites');
          }
        });
      } catch(err){ console.error('like tx err', err); showToast('Could not toggle like: '+(err.message||err), 'error'); }
      finally { favBtn.disabled = false; await refreshUserLikeState(); }
    };

    favBtn.addEventListener('click', handleLike);
    topLikeBtn.addEventListener('click', handleLike);

    // -------------------- Reviews --------------------
    function subscribeReviews() {
      if (reviewsUnsub) reviewsUnsub();
      const colRef = collection(db, REVIEWS_COL);
      const q = query(colRef, where('gid','==', GIG_ID), orderBy('createdAt','desc'), limit(50));
      reviewsUnsub = onSnapshot(q, snap=>{
        reviewsList.innerHTML = '';
        if (snap.empty) { reviewsList.innerHTML = '<div class="muted">No reviews yet</div>'; return; }
        snap.forEach(d=>{
          const r = d.data();
          const el = document.createElement('div'); el.className='review';
          const initials = (r.authorName||'U')[0]||'U';
          const date = r.createdAt ? (r.createdAt.toDate ? r.createdAt.toDate().toLocaleDateString() : new Date(r.createdAt).toLocaleDateString()) : '';
          el.innerHTML = `<div style="width:44px;height:44px;border-radius:10px;background:#072a23;display:grid;place-items:center;font-weight:800">${initials}</div>
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:800">${r.authorName||'User'}</div>
                <div class="small muted">${date}</div>
              </div>
              <div class="small muted" style="margin-top:6px"><span class="rating-stars">${'★'.repeat(r.stars || 0)}${'☆'.repeat(5 - (r.stars || 0))}</span> — ${r.text || ''}</div>
            </div>`;
          reviewsList.appendChild(el);
        });
      }, err => { console.warn('reviews listen err', err); });
    }

    addReviewBtn.addEventListener('click', async ()=>{
      reviewStatus.textContent = '';
      if (!currentUser) { if (confirm('Login required to post review. Go to login?')) window.location='login.html'; return; }
      const text = reviewText.value.trim(); const starsVal = selectedRating;
      if (!text) { reviewStatus.textContent = 'Write something first'; return; }
      addReviewBtn.disabled = true; addReviewBtn.innerHTML = '<div class="loading-spinner"></div>';
      try {
        await addDoc(collection(db, REVIEWS_COL), { gid: GIG_ID, authorId: currentUser.uid, authorName: currentUser.displayName || currentUser.email || 'User', text, stars: starsVal, createdAt: serverTimestamp() });
        reviewStatus.textContent = 'Posted ✓'; reviewText.value = ''; showToast('Review posted successfully');
      } catch (err) { console.error('post review err', err); reviewStatus.textContent = 'Could not post: ' + (err.message||err); showToast('Could not post review: ' + (err.message||err), 'error'); }
      finally { addReviewBtn.disabled = false; addReviewBtn.innerHTML = 'Post Review'; }
    });

    // -------------------- Related gigs --------------------
    function loadRelatedGigs(category) {
      if (similarUnsub) similarUnsub(); similarGrid.innerHTML = '';
      if (!category) { similarGrid.innerHTML = '<div class="muted">No related gigs</div>'; return; }
      const colRef = collection(db, GIGS_COL);
      const q = query(colRef, where('category','==', category), orderBy('createdAt','desc'), limit(6));
      similarUnsub = onSnapshot(q, snap=>{
        similarGrid.innerHTML = '';
        if (snap.empty) { similarGrid.innerHTML = '<div class="muted">No related gigs</div>'; return; }
        snap.forEach(d=>{
          if (d.id === GIG_ID) return;
          const g = d.data();
          const card = document.createElement('a');
          card.href = `gig-details.html?id=${d.id}`;
          card.className = 'card'; card.style.padding='12px'; card.style.display='block'; card.style.textDecoration='none'; card.style.color='inherit'; card.style.transition='var(--transition)'; card.style.height='100%';
          const img = (Array.isArray(g.images) && g.images[0]) || g.coverURL || 'https://via.placeholder.com/600x400?text=No+Image';
          card.innerHTML = `<div style="height:140px;border-radius:8px;background-image:url(${escapeImg(img)});background-size:cover;background-position:center"></div>
            <div style="margin-top:12px"><div style="font-weight:800;font-size:16px;margin-bottom:8px">${g.title||'Untitled'}</div>
              <div style="display:flex;justify-content:space-between;align-items:center"><div class="small muted">From ₹${g.price||0}</div><div class="small rating-stars">${'★'.repeat(4)}☆</div></div></div>`;
          similarGrid.appendChild(card);
        });
      }, err => { console.warn('related listen err', err); similarGrid.innerHTML = '<div class="muted">Could not load related gigs</div>'; });
    }

    // -------------------- Seller profile --------------------
    function subscribeSeller(uid) {
      if (!uid) return;
      if (sellerUnsub) sellerUnsub();
      const uRef = doc(db, USERS_COL, uid);
      sellerUnsub = onSnapshot(uRef, s=>{
        if (!s.exists()) {
          panelSellerName.textContent = gigData?.sellerName || 'Seller'; panelSellerRole.textContent = gigData?.sellerRole || ''; sellerPhoto.src = gigData?.sellerPhoto || ''; sellerName.textContent = gigData?.sellerName || 'Seller'; sellerBio.textContent = gigData?.sellerBio || ''; sellerSince.textContent = gigData?.sellerSince ? '• Since ' + gigData.sellerSince : '';
          return;
        }
        const u = s.data();
        panelSellerName.textContent = u.fullName || u.displayName || (u.company || 'Seller');
        panelSellerRole.textContent = u.title || u.role || '';
        sellerPhoto.src = u.photoURL || gigData?.sellerPhoto || '';
        sellerName.textContent = u.fullName || u.displayName || gigData?.sellerName || 'Seller';
        sellerBio.textContent = u.bio || gigData?.sellerBio || '';
        sellerSince.textContent = u.since ? '• Since ' + u.since : (gigData?.sellerSince ? '• Since ' + gigData.sellerSince : '');
        sellerProfileLink.href = `seller.html?id=${s.id}`;
      }, err => { console.warn('seller listen err', err); });
    }

    // -------------------- Contact & Continue --------------------
    contactBtn.addEventListener('click', ()=>{
      if (!gigData) return alert('Not loaded yet');
      const sellerId = gigData.createdByUid || gigData.sellerId || gigData.createdByUid || '';
      if (!sellerId) return alert('Contact not available');
      if (sellerId.includes('@')) window.location = `mailto:${encodeURIComponent(sellerId)}?subject=${encodeURIComponent('Inquiry about: '+(gigData.title||'Gig'))}`;
      else window.location = `client-messages.html?to=${encodeURIComponent(sellerId)}`;
    });

    continueBtn.addEventListener('click', ()=>{
      if (!currentUser) { if (confirm('Login required to continue. Go to login?')) window.location='login.html'; return; }
      window.location = `continue.html?id=${GIG_ID}&col=${GIGS_COL}`;
    });

    // -------------------- Tabs behaviour --------------------
    $$('.tab').forEach(t=>{ t.addEventListener('click', ()=>{ $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); const tab = t.dataset.tab; $('#detailsTab').classList.toggle('hidden', tab!=='details'); $('#reviewsTab').classList.toggle('hidden', tab!=='reviews'); $('#faqTab').classList.toggle('hidden', tab!=='faq'); $('#similarTab').classList.toggle('hidden', tab!=='similar'); }); });

    // -------------------- Auth state --------------------
    onAuthStateChanged(auth, user=>{ currentUser = user; loginStatus.textContent = user ? `Logged in: ${user.displayName || user.email || user.uid}` : 'Not logged in'; refreshUserLikeState(); });

    // -------------------- Initial subscriptions --------------------
    // subscribe gig doc realtime
    const gigRef = doc(db, GIGS_COL, GIG_ID);
    onSnapshot(gigRef, snap => {
      if (!snap.exists()) {
        gigTitle.textContent = 'Gig not found'; descEl.textContent = ''; return;
      }
      gigData = { id: snap.id, ...snap.data() };
      renderGig(gigData);
      watchLikes(GIG_ID);
      subscribeReviews();
      loadRelatedGigs(gigData.category);
      subscribeSeller(gigData.createdByUid || gigData.sellerId || gigData.createdByUid);
    }, err => { console.error('gig snapshot err', err); showToast('Could not load gig: ' + (err.message||err), 'error'); });

    // small safety: load reviews initially
    subscribeReviews();

    // Load FAQ (from gig or default)
    function loadFAQFromGig(g){
      const faqs = g && g.faqs && Array.isArray(g.faqs) && g.faqs.length ? g.faqs : [
        { question: 'How long does it take to complete a project?', answer: 'Delivery depends on the package you choose.' },
        { question: 'What do I need to provide to get started?', answer: 'Provide your brand name, references, and requirements.' }
      ];
      faqList.innerHTML = '';
      faqs.forEach((faq)=>{
        const item = document.createElement('div'); item.className='faq-item'; item.innerHTML = `<div class="faq-question">${faq.question}<span class="faq-toggle"><i class="fas fa-chevron-down"></i></span></div><div class="faq-answer">${faq.answer}</div>`;
        item.addEventListener('click', ()=> item.classList.toggle('active'));
        faqList.appendChild(item);
      });
    }

    // react to gig changes for faq
    onSnapshot(gigRef, s=>{ if (s.exists()) loadFAQFromGig(s.data()); });

  </script></body>
</html>
