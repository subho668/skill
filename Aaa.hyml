<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create Gig — Talent-Hub (Pro) — Updated</title>
  <meta name="description"
    content="Create a professional gig — Talent-Hub. Category-driven dynamic features, per-plan edits, title limits, improved editor." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    :root {
      --bg1: #07102a;
      --bg2: #040718;
      --ink: #e6eefb;
      --muted: #9db2cf;
      --glass: rgba(255, 255, 255, .03);
      --b: rgba(255, 255, 255, .05);
      --brand: #34d399;
      --brand-ink: #062d22;
      --panel: #0b1226;
    }

    body {
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color: var(--ink);
      margin: 0
    }

    .glass {
      background: var(--glass);
      backdrop-filter: blur(8px);
      border: 1px solid var(--b);
      border-radius: 12px
    }

    .input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .02);
      border: 1px solid rgba(255, 255, 255, .06);
      color: var(--ink)
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 700;
      background: rgba(255, 255, 255, .03);
      border: 1px solid rgba(255, 255, 255, .06);
      color: var(--ink)
    }

    .btn-brand {
      background: var(--brand);
      color: var(--brand-ink);
      border: none
    }

    .thumb {
      width: 100px;
      height: 74px;
      border-radius: 8px;
      background: #0e1836 center/cover no-repeat;
      border: 1px solid rgba(255, 255, 255, .06)
    }

    .soft {
      background: rgba(255, 255, 255, .017);
      border-radius: 10px;
      padding: 12px;
      border: 1px dashed rgba(255, 255, 255, .04)
    }

    .plan-column {
      background: rgba(255, 255, 255, .015);
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, .04)
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .02);
      border: 1px solid rgba(255, 255, 255, .04);
      font-size: 12px
    }

    .step-dot {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, .12);
      display: flex;
      align-items: center;
      justify-content: center
    }

    .step-dot.active {
      background: var(--brand);
      color: var(--brand-ink);
      border-color: transparent
    }

    .preview-cover {
      aspect-ratio: 16/9;
      background: #12102b center/cover no-repeat;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, .06)
    }

    /* darker dropdowns / panels for contrast */
    select.input,
    .input {
      background: rgba(0, 0, 0, 0.26);
      color: var(--ink);
    }

    /* Quill editor tweak */
    .ql-toolbar.ql-snow {
      background: #0f1724;
      border: 1px solid rgba(255, 255, 255, .06);
      color: var(--ink)
    }

    .ql-container.ql-snow {
      background: #071426;
      color: #e6eefb;
      border: 1px solid rgba(255, 255, 255, .06);
      border-top: none
    }

    /* small helper */
    .text-muted {
      color: #9fb0cc;
      font-size: 13px
    }

    .flex-between {
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    .extra-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px
    }

    .kicker {
      font-weight: 800;
      letter-spacing: .08em;
      color: #9db2cf;
      font-size: 12px
    }

    .danger {
      border-color: rgba(255, 100, 100, .45) !important;
    }
  </style>
</head>

<body class="min-h-screen">

  <nav class="glass sticky top-0 z-40 px-4 py-3 max-w-6xl mx-auto mt-3 flex items-center justify-between">
    <a href="index.html" class="text-2xl font-extrabold text-emerald-400">Talent-Hub Pro</a>
    <div class="flex items-center gap-2">
      <span id="loginStatus" class="px-3 py-1 rounded-full text-sm" aria-live="polite">Checking auth…</span>
      <a id="loginBtnLink" href="login.html" class="btn">Login</a>
      <button id="btnLogout" class="btn hidden">Logout</button>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto px-4 py-6 grid lg:grid-cols-3 gap-6">
    <section class="lg:col-span-2 glass p-5 space-y-4">

      <div class="flex-between">
        <div>
          <div class="kicker">Create new gig</div>
          <h1 class="text-2xl font-extrabold mt-1">Create a Pro Gig</h1>
        </div>
        <div class="text-sm text-muted">Autosave: <span id="autosaveStatus">Idle</span></div>
      </div>

      <div class="flex gap-2 overflow-x-auto">
        <button data-step="1" class="step-tab btn">1 Overview</button>
        <button data-step="2" class="step-tab btn">2 Pricing</button>
        <button data-step="3" class="step-tab btn">3 Description & FAQ</button>
        <button data-step="4" class="step-tab btn">4 Requirements</button>
        <button data-step="5" class="step-tab btn">5 Media</button>
        <button data-step="6" class="step-tab btn">6 Publish</button>
      </div>

      <form id="gigForm" class="space-y-6">

        <!-- STEP 1 Overview -->
        <div id="step-1" class="step-pane">
          <label class="block mb-1">Gig Title <span class="text-muted text-xs"> (max 50 chars)</span></label>
          <input id="title" class="input" maxlength="50" placeholder="I will design a professional logo" />
          <div class="mt-1 text-xs text-muted flex-between">
            <div id="titleCount">0/50</div>
            <div id="titleHint" class="text-muted">Be specific and niche</div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
            <div>
              <label class="block mb-1">Category</label>
              <select id="category" class="input">
                <option value="">Choose a category</option>
                <option value="graphic">Graphics & Design</option>
                <option value="web">Programming & Tech</option>
                <option value="marketing">Digital Marketing</option>
                <option value="video">Video & Animation</option>
                <option value="writing">Writing & Translation</option>
                <option value="music">Music & Audio</option>
                <option value="ai">AI Services</option>
              </select>
            </div>
            <div>
              <label class="block mb-1">Subcategory</label>
              <select id="subcategory" class="input">
                <option value="">Choose subcategory</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
            <div>
              <label class="block mb-1">Tags (comma separated)</label>
              <input id="tags" class="input" placeholder="branding, minimal, vector" />
            </div>
            <div>
              <label class="block mb-1">Skills</label>
              <input id="skills" class="input"
                placeholder="Add skills separated by comma (e.g. Photoshop, After Effects)" />
              <div class="text-xs text-muted mt-1">Will be stored as individual skills</div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
            <div>
              <label class="block mb-1">Languages</label>
              <input id="languages" class="input" placeholder="Add languages (e.g. English, Hindi)" />
              <div class="text-xs text-muted mt-1">Comma separated</div>
            </div>
            <div>
              <label class="block mb-1">Platform</label>
              <select id="platform" class="input">
                <option value="">Any</option>
                <option>YouTube</option>
                <option>TikTok</option>
                <option>Instagram</option>
              </select>
            </div>
          </div>

          <div class="mt-3 soft">
            <div class="font-semibold">SEO & Suggestions</div>
            <div class="text-sm mt-2">Keywords: <span id="kwSuggestions">—</span></div>
            <div class="text-xs mt-2">Quality score: <span id="qualityScore">0</span>%</div>
          </div>
        </div>

        <!-- STEP 2 Pricing (dynamic per category) -->
        <div id="step-2" class="step-pane hidden">
          <div class="flex-between mb-2">
            <div class="kicker">Pricing — set three packages</div>
            <div class="text-xs text-muted">You can add extras and edit delivery/revisions per plan</div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="plan-column">
              <div class="text-center">
                <input class="input text-center plan-name" value="Starter" />
                <div class="mt-2">₹ <input type="number" class="input inline w-28 plan-price" value="999" /></div>
                <textarea class="input mt-2 plan-desc" rows="2">Essential package</textarea>
                <div class="extra-row">
                  <input class="input w-1/2 plan-delivery" placeholder="Days" value="3" />
                  <input class="input w-1/2 plan-revisions" placeholder="Revisions" value="1" />
                </div>
                <div class="mt-2 plan-extras"></div>
                <button type="button" class="btn mt-2 add-extra">+ Add Extra</button>
              </div>
            </div>

            <div class="plan-column">
              <div class="text-center">
                <input class="input text-center plan-name" value="Growth" />
                <div class="mt-2">₹ <input type="number" class="input inline w-28 plan-price" value="1999" /></div>
                <textarea class="input mt-2 plan-desc" rows="2">Popular package</textarea>
                <div class="extra-row">
                  <input class="input w-1/2 plan-delivery" placeholder="Days" value="5" />
                  <input class="input w-1/2 plan-revisions" placeholder="Revisions" value="2" />
                </div>
                <div class="mt-2 plan-extras"></div>
                <button type="button" class="btn mt-2 add-extra">+ Add Extra</button>
              </div>
            </div>

            <div class="plan-column">
              <div class="text-center">
                <input class="input text-center plan-name" value="Elite" />
                <div class="mt-2">₹ <input type="number" class="input inline w-28 plan-price" value="2999" /></div>
                <textarea class="input mt-2 plan-desc" rows="2">Complete package</textarea>
                <div class="extra-row">
                  <input class="input w-1/2 plan-delivery" placeholder="Days" value="7" />
                  <input class="input w-1/2 plan-revisions" placeholder="Revisions" value="Unlimited" />
                </div>
                <div class="mt-2 plan-extras"></div>
                <button type="button" class="btn mt-2 add-extra">+ Add Extra</button>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
            <div>
              <label class="block mb-1">Default delivery time for buyer selector</label>
              <select id="deliveryTime" class="input">
                <option>1</option>
                <option>2</option>
                <option selected>3</option>
                <option>5</option>
                <option>7</option>
              </select>
            </div>
            <div>
              <label class="block mb-1">Auto-price: Base hourly (₹)</label>
              <input id="baseHourly" type="number" class="input" placeholder="e.g., 500" />
            </div>
            <div class="flex items-end">
              <button id="btnGeneratePrices" type="button" class="btn btn-brand">Generate Packages</button>
            </div>
          </div>

          <div class="mt-4 soft">
            <div class="text-sm text-muted">After choosing category, click Generate Packages to get smart defaults for
              prices/delivery/revisions. You can edit each plan manually (delivery, revisions, extras).</div>
          </div>
        </div>

        <!-- STEP 3 Description & FAQ -->
        <div id="step-3" class="step-pane hidden">
          <label class="block mb-1">Description</label>
          <div id="quillEditor" style="height:220px;border-radius:8px;background:#071426"></div>
          <div class="flex-between mt-2 text-xs text-muted">
            <div id="descCount">0 / 1200</div>
            <div class="text-muted">Explain deliverables & process</div>
          </div>

          <div class="mt-4">
            <div class="flex-between">
              <div class="kicker">FAQ</div>
              <div class="text-xs text-muted">Add common buyer questions</div>
            </div>
            <div id="faqContainer" class="mt-2"></div>
            <button type="button" id="addFaqBtn" class="btn mt-2">+ Add FAQ</button>
          </div>
        </div>

        <!-- STEP 4 Requirements -->
        <div id="step-4" class="step-pane hidden">
          <div class="flex-between">
            <div class="kicker">Buyer Requirements</div>
            <div class="text-xs text-muted">What you need to start</div>
          </div>
          <div id="requirementsContainer" class="mt-2"></div>
          <button id="addRequirementBtn" type="button" class="btn mt-2">+ Add Requirement</button>

          <div class="mt-4 soft">
            <label class="block mb-1">Smart Templates</label>
            <select id="tplSelect" class="input">
              <option value="">Choose template</option>
              <option value="video-editing">Video Editing</option>
              <option value="logo-design">Logo Design</option>
              <option value="web-dev">Web Development</option>
              <option value="audio">Audio</option>
            </select>
          </div>
        </div>

        <!-- STEP 5 Media -->
        <div id="step-5" class="step-pane hidden">
          <label class="block mb-1">Cover Images & Video</label>
          <div id="dropzone" class="soft dropzone" style="cursor:pointer">Drag & drop or click to upload (max 8 images +
            1 video, 30MB each)</div>
          <input id="fileInput" type="file" accept="image/*,video/*" multiple class="hidden" />
          <div id="mediaPreview" class="mt-3 flex gap-2 flex-wrap"></div>
          <div class="mt-4 soft">
            <div class="font-semibold">AI Quality Check</div>
            <div class="text-sm mt-2" id="aiQuality">No media uploaded</div>
          </div>
        </div>

        <!-- STEP 6 Publish -->
        <div id="step-6" class="step-pane hidden">
          <div class="soft">
            <div class="font-bold">SEO Checklist</div>
            <div class="mt-2 text-sm" id="seoChecklist"></div>
          </div>

          <div class="mt-3 flex gap-2">
            <button id="btnSaveDraft" type="button" class="btn">Save Draft</button>
            <button id="btnPublish" type="button" class="btn btn-brand">Publish Gig</button>
            <button id="btnReset" type="button" class="btn">Reset</button>
          </div>

          <div id="formStatus" class="mt-3 text-sm"></div>
          <div class="mt-4 soft">
            <div class="font-semibold">Preview JSON</div>
            <pre id="debugJson" class="code text-xs p-2 overflow-auto"></pre>
          </div>
        </div>

      </form>

      <div class="flex-between mt-4">
        <button id="btnPrev" class="btn">← Prev</button>
        <div class="text-sm text-slate-300" id="stepNote">Step 1 of 6</div>
        <button id="btnNext" class="btn">Next →</button>
      </div>

    </section>

    <!-- RIGHT: preview & profile -->
    <aside class="space-y-4">
      <div class="glass p-4">
        <div class="text-xs text-muted">Your profile</div>
        <div class="flex items-center gap-3 mt-2"><img id="uPhoto" class="w-12 h-12 rounded-full object-cover"
            src="https://via.placeholder.com/80" />
          <div>
            <div id="uName" class="font-bold">—</div>
            <div id="uEmail" class="text-xs text-muted">—</div>
          </div>
        </div>
      </div>

      <div class="glass p-4 stick">
        <div class="text-xs text-muted">Live preview</div>
        <div id="liveThumb" class="preview-cover mt-2"
          style="background-image:url('https://via.placeholder.com/1200x800?text=Preview')"></div>
        <div class="mt-3">
          <div class="text-slate-300 text-xs">Title</div>
          <div id="pvTitle" class="font-extrabold text-lg truncate">—</div>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <div class="soft p-2">
            <div class="text-[11px] text-slate-400">Category</div>
            <div id="pvCat" class="font-semibold text-sm">—</div>
          </div>
          <div class="soft p-2">
            <div class="text-[11px] text-slate-400">Delivery</div>
            <div id="pvDel" class="font-semibold text-sm">—</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <div class="soft p-2">
            <div class="text-[11px] text-slate-400">Price</div>
            <div id="pvPrice" class="font-black text-emerald-300 text-base">₹0</div>
          </div>
          <div class="soft p-2">
            <div class="text-[11px] text-slate-400">Revisions</div>
            <div id="pvRev" class="font-semibold text-sm">—</div>
          </div>
        </div>
        <div class="mt-2 text-[11px] text-slate-400">Features</div>
        <div id="pvFeat" class="flex gap-1 flex-wrap mt-1 text-xs"></div>
      </div>

      <div class="glass p-4">
        <div class="text-xs text-muted">Pro tips</div>
        <ul class="list-disc list-inside text-sm text-slate-300 mt-2">
          <li>Use 5–8 tags & clear title</li>
          <li>Upload at least 3 portfolio images</li>
          <li>Add an intro video for higher conversions</li>
        </ul>
      </div>
    </aside>

  </main>

  <footer class="text-center py-8 text-slate-300">© 2025 Talent-Hub Pro</footer>

  <!-- FIREBASE + LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBxNGIBexYUb-LecKJRgxPNsY5ZFN1_zUA",
      authDomain: "skillspot-pro.firebaseapp.com",
      projectId: "skillspot-pro",
      storageBucket: "skillspot-pro.appspot.com",
      messagingSenderId: "600467343030",
      appId: "1:600467343030:web:ad985d8e95b3ea99c64817",
      measurementId: "G-TYL2XF4WZY"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // Elements
    const loginStatus = $('#loginStatus'), loginBtnLink = $('#loginBtnLink'), btnLogout = $('#btnLogout');
    const uPhoto = $('#uPhoto'), uName = $('#uName'), uEmail = $('#uEmail');
    const titleEl = $('#title'), titleCount = $('#titleCount');
    const categoryEl = $('#category'), subcatEl = $('#subcategory'), tagsEl = $('#tags');
    const skillsEl = $('#skills'), languagesEl = $('#languages'), platformEl = $('#platform');
    const kwSuggestions = $('#kwSuggestions'), qualityScoreEl = $('#qualityScore'), seoChecklist = $('#seoChecklist');
    const autosaveStatus = $('#autosaveStatus');
    const btnPrev = $('#btnPrev'), btnNext = $('#btnNext'), stepNote = $('#stepNote'), stepTabs = $$('.step-tab');
    const btnGeneratePrices = $('#btnGeneratePrices'), baseHourlyEl = $('#baseHourly'), deliveryEl = $('#deliveryTime');
    const btnSaveDraft = $('#btnSaveDraft'), btnPublish = $('#btnPublish'), btnReset = $('#btnReset'), formStatus = $('#formStatus'), debugJson = $('#debugJson');
    const pvTitle = $('#pvTitle'), pvCat = $('#pvCat'), pvDel = $('#pvDel'), pvPrice = $('#pvPrice'), pvRev = $('#pvRev'), pvFeat = $('#pvFeat'), liveThumb = $('#liveThumb');
    const dropzone = $('#dropzone'), fileInput = $('#fileInput'), mediaPreview = $('#mediaPreview'), aiQuality = $('#aiQuality');

    let currentUser = null;
    let currentStep = 1, maxStep = 6;
    const GIGS_COLLECTION = 'subho_gigs';

    // Quill
    const quill = new Quill('#quillEditor', { theme: 'snow' });

    // Category map (subcategories + features)
    const CATEGORY_MAP = {
      graphic: {
        subs: ['Logo Design', 'Brand Style Guides', 'Illustration', 'Business Cards', 'Social Media Design', 'Book Covers', 'Packaging Design'],
        features: ['Source Files', 'Vector files', '3 Revisions', 'Favicon', 'Mockups']
      },
      web: {
        subs: ['Website Development', 'App Development', 'Game Development', 'E-commerce Development', 'Cybersecurity', 'AI Development'],
        features: ['Responsive', 'SEO basic', 'CMS', '1 Month Support', 'Source Code']
      },
      marketing: {
        subs: ['Social Media Marketing', 'SEO', 'Content Marketing', 'Email Marketing', 'Influencer Marketing', 'Video Marketing', 'Affiliate Marketing'],
        features: ['3 Creatives', 'Ad Copy', 'A/B Variations', 'Targeting Suggestion', 'Analytics Report']
      },
      video: {
        subs: ['Video Editing', '2D Animation', '3D Animation', 'Whiteboard Animation', 'Short Video Ads', 'Intro/Outro'],
        features: ['Color Grade', 'Sound Mix', 'Captions', 'Intro Animation', 'Source Files']
      },
      writing: {
        subs: ['Articles & Blogs', 'Copywriting', 'Translation', 'Proofreading', 'Technical Writing', 'Resume Writing'],
        features: ['SEO keywords', 'Meta tags', 'Plagiarism check', '2 Revisions', 'References']
      },
      music: {
        subs: ['Voice Over', 'Mixing & Mastering', 'Podcast Editing', 'Jingles', 'Sound Effects'],
        features: ['Stem Files', 'Mastered', 'Commercial License', 'Multiple Takes', 'Lyrics']
      },
      ai: {
        subs: ['AI Art', 'AI Content Writing', 'AI Chatbot', 'AI Automation', 'AI Video Creation'],
        features: ['Model Selection', 'Dataset Prep', 'API Integration', '2 Iterations', 'Docs']
      }
    };

    // Auth UI
    onAuthStateChanged(auth, async (user) => {
      if (!user) { loginStatus.textContent = 'Not logged in'; btnLogout.classList.add('hidden'); loginBtnLink.classList.remove('hidden'); currentUser = null; uName.textContent = '—'; uEmail.textContent = '—'; uPhoto.src = 'https://via.placeholder.com/80'; return; }
      currentUser = user; loginStatus.textContent = `Logged in: ${user.email || user.displayName || user.uid}`; btnLogout.classList.remove('hidden'); loginBtnLink.classList.add('hidden');
      uName.textContent = user.displayName || (user.email ? user.email.split('@')[0] : user.uid); uEmail.textContent = user.email || user.uid; uPhoto.src = user.photoURL || 'https://via.placeholder.com/80';
      if (!user.displayName && user.email) { try { await updateProfile(user, { displayName: user.email.split('@')[0] }); } catch (e) { } }
    });
    btnLogout.addEventListener('click', async () => { try { await signOut(auth); location.href = 'index.html'; } catch (e) { alert('Logout failed') } });

    // Step nav
    function gotoStep(n) {
      currentStep = Math.max(1, Math.min(maxStep, n));
      for (let i = 1; i <= maxStep; i++) { const pane = document.getElementById('step-' + i); if (pane) pane.classList.toggle('hidden', i !== currentStep); }
      stepNote.textContent = `Step ${currentStep} of ${maxStep}`;
      stepTabs.forEach(btn => btn.classList.toggle('btn-brand', Number(btn.dataset.step) === currentStep));
      if (currentStep === 6) { buildSEOChecklist(); renderDebug(); }
      renderPreview();
    }
    stepTabs.forEach(btn => btn.addEventListener('click', () => gotoStep(Number(btn.dataset.step))));
    btnPrev.addEventListener('click', () => gotoStep(currentStep - 1));
    btnNext.addEventListener('click', () => gotoStep(currentStep + 1));
    gotoStep(1);

    // Populate subcategories + features when category changes
    function populateSubcategories(cat) {
      subcatEl.innerHTML = '<option value="">Choose subcategory</option>';
      if (!cat || !CATEGORY_MAP[cat]) return;
      CATEGORY_MAP[cat].subs.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; subcatEl.appendChild(o); });
    }
    function populatePlanFeatureLists(cat) {
      const features = (cat && CATEGORY_MAP[cat]) ? CATEGORY_MAP[cat].features : ['Source Files', 'Revisions', 'Support', 'Custom Request'];
      document.querySelectorAll('.plan-column').forEach((col) => {
        const container = col.querySelector('.plan-extras');
        container.innerHTML = ''; // we use extras area for showing selected features (as checkboxes)
        // create checkboxes to allow toggling which features apply across plans
        features.forEach((f, idx) => {
          const wrap = document.createElement('div');
          wrap.style.display = 'flex'; wrap.style.alignItems = 'center'; wrap.style.justifyContent = 'space-between'; wrap.style.marginTop = '6px';
          wrap.innerHTML = `<label style="font-size:13px"><input type="checkbox" class="feat-chk" data-feature="${f}" ${idx === 0 ? 'checked' : ''}/> ${f}</label> <small class="text-muted" style="opacity:.8">— toggle</small>`;
          container.appendChild(wrap);
        });
      });
      renderPreview();
    }
    categoryEl.addEventListener('change', () => { populateSubcategories(categoryEl.value); populatePlanFeatureLists(categoryEl.value); computeKeywordsAndScore(); autosaveNow('category'); });
    populatePlanFeatureLists('');

    // Title char counter (max 50)
    titleEl.addEventListener('input', () => { const v = titleEl.value.slice(0, 50); if (v !== titleEl.value) titleEl.value = v; titleCount.textContent = `${titleEl.value.length}/50`; computeKeywordsAndScore(); autosaveNow('title'); renderPreview(); });

    // Skills & Languages: store as comma separated, no fancy widget now
    skillsEl.addEventListener('change', () => autosaveNow('skills'));
    languagesEl.addEventListener('change', () => autosaveNow('languages'));

    // Generate packages (fills price + default delivery/revisions)
    btnGeneratePrices.addEventListener('click', () => {
      const base = Number(baseHourlyEl.value || 0);
      const priceInputs = document.querySelectorAll('.plan-price');
      const deliveryInputs = document.querySelectorAll('.plan-delivery');
      const revisionsInputs = document.querySelectorAll('.plan-revisions');
      let prices;
      if (base <= 0) prices = [999, 1999, 2999];
      else prices = [Math.max(99, Math.round(base * 1.6)), Math.max(199, Math.round(base * 3.0)), Math.max(299, Math.round(base * 5.0))];
      priceInputs.forEach((p, i) => p.value = prices[i] || 0);
      // sensible defaults for delivery and revisions
      deliveryInputs.forEach((d, i) => { if (!d.value) d.value = [3, 5, 7][i]; });
      revisionsInputs.forEach((r, i) => { if (!r.value) r.value = [1, 2, 'Unlimited'][i]; });
      renderPreview(); autosaveNow('pricing');
    });

    // Add Extra button per plan (adds custom extras with price)
    document.addEventListener('click', (e) => {
      if (e.target.matches('.add-extra')) {
        const col = e.target.closest('.plan-column');
        const extras = col.querySelector('.plan-extras');
        const wrapper = document.createElement('div'); wrapper.style.marginTop = '8px';
        wrapper.innerHTML = `<div style="display:flex;gap:8px"><input class="input extra-label" placeholder="Extra label (e.g., Priority Delivery)" /><input type="number" class="input extra-price" placeholder="₹ price" /><button class="btn remove-extra">Remove</button></div>`;
        extras.appendChild(wrapper);
        wrapper.querySelector('.remove-extra').addEventListener('click', () => { wrapper.remove(); autosaveNow('extras'); });
        autosaveNow('extras');
      }
    });

    // FAQ add/remove
    $('#addFaqBtn').addEventListener('click', () => {
      const c = $('#faqContainer');
      const i = document.createElement('div'); i.className = 'mt-2 soft p-3';
      i.innerHTML = `<input class='input faq-q mb-2' placeholder='Question' /><textarea class='input faq-a' rows='2' placeholder='Answer'></textarea><div class='mt-2'><button class='btn remove-faq'>Remove</button></div>`;
      c.appendChild(i);
      i.querySelector('.remove-faq').addEventListener('click', () => { i.remove(); autosaveNow('faq'); });
      autosaveNow('faq');
    });

    // Requirements add/remove and templates (custom editable)
    $('#addRequirementBtn').addEventListener('click', () => {
      const c = $('#requirementsContainer');
      const n = document.createElement('div'); n.className = 'mt-2 soft p-3';
      n.innerHTML = `<select class='input mb-2 req-type'><option value='text'>Text</option><option value='file'>File</option><option value='choice'>Multiple Choice</option></select><input class='input req-q' placeholder='Question or instruction' /><div class='mt-2'><button class='btn remove-req'>Remove</button></div>`;
      c.appendChild(n);
      n.querySelector('.remove-req').addEventListener('click', () => { n.remove(); autosaveNow('req'); });
      autosaveNow('req');
    });

    $('#tplSelect').addEventListener('change', (e) => {
      const v = e.target.value;
      const c = $('#requirementsContainer');
      if (v === 'video-editing') {
        c.innerHTML = `<div class='soft p-3'><label class='text-sm'>Please upload raw footage (mp4), script, timestamps for cuts, brand assets (logo)</label></div>`;
      } else if (v === 'logo-design') {
        c.innerHTML = `<div class='soft p-3'><label class='text-sm'>Provide brand name, colors, style references, existing logos (if any)</label></div>`;
      } else if (v === 'web-dev') {
        c.innerHTML = `<div class='soft p-3'><label class='text-sm'>Provide hosting details, admin access, design examples, required features</label></div>`;
      } else if (v === 'audio') {
        c.innerHTML = `<div class='soft p-3'><label class='text-sm'>Provide script, reference voice sample, tone, music preference</label></div>`;
      }
      autosaveNow('tpl');
    });

    // Media drag/drop + preview, limits 8 images + 1 video
    let mediaFiles = [];
    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('ring'); });
    dropzone.addEventListener('dragleave', e => { dropzone.classList.remove('ring'); });
    dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('ring'); handleFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', () => handleFiles(fileInput.files));

    function handleFiles(list) {
      const arr = Array.from(list);
      const imagesOnly = arr.filter(f => f.type.startsWith('image/'));
      const videos = arr.filter(f => f.type.startsWith('video/'));
      const currentImgs = mediaFiles.filter(m => m.type.startsWith('image/')).length;
      const currentVideos = mediaFiles.filter(m => m.type.startsWith('video/')).length;
      const imgToAdd = imagesOnly.slice(0, Math.max(0, 8 - currentImgs));
      const vidToAdd = videos.slice(0, Math.max(0, 1 - currentVideos));
      const toAdd = [...imgToAdd, ...vidToAdd];
      toAdd.forEach(f => {
        if (f.size > 30 * 1024 * 1024) { alert(`${f.name} is larger than 30MB and was skipped.`); return; }
        mediaFiles.push(f);
      });
      renderMediaPreview();
      runAIQualityCheck();
      autosaveNow('media');
    }

    function renderMediaPreview() {
      mediaPreview.innerHTML = '';
      mediaFiles.forEach((f, idx) => {
        const wrap = document.createElement('div'); wrap.className = 'p-1';
        if (f.type.startsWith('image/')) {
          const url = URL.createObjectURL(f);
          const d = document.createElement('div'); d.className = 'thumb'; d.style.backgroundImage = `url('${url}')`;
          wrap.appendChild(d);
        } else {
          const video = document.createElement('video'); video.controls = true; video.width = 160; video.height = 90; video.src = URL.createObjectURL(f); video.style.borderRadius = '8px';
          wrap.appendChild(video);
        }
        const rem = document.createElement('div'); rem.className = 'mt-1'; rem.innerHTML = `<button data-idx='${idx}' class='btn text-xs remove-media'>Remove</button>`;
        rem.querySelector('button').addEventListener('click', () => { mediaFiles.splice(idx, 1); renderMediaPreview(); runAIQualityCheck(); autosaveNow('media'); });
        wrap.appendChild(rem);
        mediaPreview.appendChild(wrap);
      });
      if (mediaFiles.length) {
        const first = mediaFiles.find(m => m.type.startsWith('image/')) || mediaFiles[0];
        liveThumb.style.backgroundImage = `url('${URL.createObjectURL(first)}')`;
      } else {
        liveThumb.style.backgroundImage = "url('https://via.placeholder.com/1200x800?text=Preview')";
      }
    }

    function runAIQualityCheck() {
      if (mediaFiles.length === 0) { aiQuality.textContent = 'No media uploaded'; return; }
      const issues = [];
      mediaFiles.forEach(f => {
        if (f.size < 4 * 1024) issues.push(`${f.name}: very small`);
        if (f.size > 30 * 1024 * 1024) issues.push(`${f.name}: >30MB`);
        if (f.type.startsWith('image/') && f.size < 10 * 1024) issues.push(`${f.name}: suspiciously tiny`);
      });
      if (issues.length) aiQuality.textContent = issues.join(' | '); else aiQuality.textContent = `Good — ${mediaFiles.length} files, total ${(mediaFiles.reduce((s, m) => s + m.size, 0) / 1024 / 1024).toFixed(2)} MB`;
    }

    // Preview helpers (robust)
    function getFirstPlanPrice() {
      const nodes = document.querySelectorAll('.plan-price');
      if (!nodes || nodes.length === 0) return 0;
      return Number(nodes[0].value || 0);
    }
    function getFirstPlanRevisions() {
      const first = document.querySelectorAll('.plan-column')[0];
      if (!first) return '—';
      const revInput = first.querySelector('.plan-revisions'); if (revInput && revInput.value) return revInput.value;
      // fallback find a feature mentioning 'Revision'
      const featLabels = Array.from(first.querySelectorAll('.plan-extras label')).map(l => l.textContent || '');
      const rev = featLabels.find(t => /revision/i.test(t));
      return rev || '—';
    }

    function renderPreview() {
      pvTitle.textContent = titleEl.value.trim() || '—';
      const catText = (categoryEl.options[categoryEl.selectedIndex]?.text || '');
      pvCat.textContent = (catText || '—') + (subcatEl.value ? ` / ${subcatEl.value}` : '');
      pvDel.textContent = (deliveryEl.value || '—') + ' Days';
      pvPrice.textContent = '₹' + getFirstPlanPrice();
      pvRev.textContent = getFirstPlanRevisions();
      pvFeat.innerHTML = '';
      const feats = Array.from(document.querySelectorAll('.plan-column .feat-chk:checked')).map(el => el.dataset.feature || (el.nextSibling ? el.nextSibling.textContent.trim() : ''));
      feats.forEach(f => {
        const span = document.createElement('span'); span.className = 'badge'; span.innerHTML = `<i class="fa-regular fa-circle-check"></i> ${f}`; pvFeat.appendChild(span);
      });
    }

    // inputs triggering preview and seo
    [titleEl, categoryEl, subcatEl, tagsEl, platformEl, deliveryEl].forEach(el => {
      el.addEventListener('input', () => { renderPreview(); computeKeywordsAndScore(); autosaveNow('fields'); });
      el.addEventListener('change', () => { renderPreview(); computeKeywordsAndScore(); autosaveNow('fields'); });
    });
    document.addEventListener('input', (e) => { if (e.target.closest('.plan-column')) renderPreview(); });
    quill.on('text-change', () => { const len = (quill.getText() || '').trim().length; $('#descCount').textContent = `${len} / 1200`; computeKeywordsAndScore(); autosaveNow('description'); });

    // SEO compute
    function computeKeywordsAndScore() {
      const text = (titleEl.value + ' ' + (quill.root.innerText || '')).toLowerCase();
      const words = text.match(/[a-z0-9]+/g) || [];
      const freq = {};
      words.forEach(w => { if (w.length < 3) return; freq[w] = (freq[w] || 0) + 1; });
      const sorted = Object.keys(freq).sort((a, b) => freq[b] - freq[a]).slice(0, 6);
      kwSuggestions.textContent = sorted.join(', ') || '—';
      const tlen = Math.min(50, titleEl.value.length);
      const dlen = Math.min(1200, (quill.root.innerText || '').length);
      const tagsCount = tagsEl.value.split(',').filter(t => t.trim()).length;
      const score = Math.max(10, Math.min(95, Math.round((tlen / 50) * 30 + (dlen / 1200) * 50 + Math.min(1, tagsCount / 6) * 20)));
      qualityScoreEl.textContent = score;
      return { keywords: sorted, score };
    }

    function buildSEOChecklist() {
      const kv = computeKeywordsAndScore();
      const items = [];
      items.push(kv.score > 50 ? 'Title & description: OK' : 'Improve title/description');
      items.push(tagsEl.value.split(',').filter(t => t.trim()).length >= 3 ? 'Tags OK' : 'Add 3–8 tags');
      items.push(mediaFiles.length > 0 ? 'Media uploaded' : 'Add at least one image');
      seoChecklist.innerHTML = items.map(i => `• ${i}`).join('<br>');
    }

    // Autosave (localStorage) - improved subtle indicator
    const AUTOSAVE_KEY = 'th_gig_autosave_v3';
    let autosaveTimer = null;
    function autosaveNow(section) {
      clearTimeout(autosaveTimer);
      autosaveStatus.textContent = 'Saving…';
      autosaveTimer = setTimeout(() => {
        try { localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(buildLocalPayload())); autosaveStatus.textContent = 'Saved'; setTimeout(() => autosaveStatus.textContent = 'Idle', 900); } catch (e) { autosaveStatus.textContent = 'Error' }
      }, 700);
    }
    setInterval(() => autosaveNow('periodic'), 15000);

    function buildLocalPayload() {
      return {
        title: titleEl.value, category: categoryEl.value, subcategory: subcatEl.value, tags: tagsEl.value, skills: skillsEl.value, languages: languagesEl.value, platform: platformEl.value,
        plans: Array.from(document.querySelectorAll('.plan-column')).map(col => ({
          name: col.querySelector('.plan-name').value,
          price: Number(col.querySelector('.plan-price').value || 0),
          desc: col.querySelector('.plan-desc').value,
          delivery: col.querySelector('.plan-delivery').value,
          revisions: col.querySelector('.plan-revisions').value,
          extras: Array.from(col.querySelectorAll('.plan-extras .extra-label')).map((el, i) => ({ label: el.value, price: Number(col.querySelectorAll('.extra-price')[i].value || 0) }))
        })),
        description: quill.root.innerHTML, requirements: Array.from($$('.req-q')).map(i => i.value), faq: Array.from($$('.faq-q')).map((q, i) => ({ q: q.value, a: $$('.faq-a')[i]?.value })), mediaCount: mediaFiles.length, timestamp: Date.now()
      };
    }

    function restoreAutosave() {
      const raw = localStorage.getItem(AUTOSAVE_KEY);
      if (!raw) return;
      try {
        const p = JSON.parse(raw);
        if (confirm('Restore autosaved draft?')) applyLocalPayload(p);
      } catch (e) { }
    }

    function applyLocalPayload(p) {
      titleEl.value = p.title || ''; titleCount.textContent = `${titleEl.value.length}/50`;
      categoryEl.value = p.category || ''; populateSubcategories(p.category); populatePlanFeatureLists(p.category);
      subcatEl.value = p.subcategory || ''; tagsEl.value = p.tags || ''; skillsEl.value = p.skills || ''; languagesEl.value = p.languages || ''; platformEl.value = p.platform || '';
      (p.plans || []).forEach((pl, i) => { const col = document.querySelectorAll('.plan-column')[i]; if (!col) return; col.querySelector('.plan-name').value = pl.name || col.querySelector('.plan-name').value; col.querySelector('.plan-price').value = pl.price || col.querySelector('.plan-price').value; col.querySelector('.plan-desc').value = pl.desc || col.querySelector('.plan-desc').value; col.querySelector('.plan-delivery').value = pl.delivery || col.querySelector('.plan-delivery').value; col.querySelector('.plan-revisions').value = pl.revisions || col.querySelector('.plan-revisions').value; });
      quill.root.innerHTML = p.description || quill.root.innerHTML;
      renderPreview(); renderMediaPreview(); computeKeywordsAndScore();
    }

    // Build payload (Not Provided defaults)
    function valOrDefault(v) { const s = String(v || '').trim(); return s === '' ? 'Not Provided' : s; }
    function buildGigPayload(status = 'published', imageUrls = []) {
      const plans = Array.from(document.querySelectorAll('.plan-column')).map(col => ({
        name: valOrDefault(col.querySelector('.plan-name').value),
        price: Number(col.querySelector('.plan-price').value || 0),
        description: valOrDefault(col.querySelector('.plan-desc').value),
        delivery: valOrDefault(col.querySelector('.plan-delivery').value),
        revisions: valOrDefault(col.querySelector('.plan-revisions').value),
        extras: Array.from(col.querySelectorAll('.plan-extras .extra-label')).map((el, i) => ({ label: el.value || 'Extra', price: Number(col.querySelectorAll('.extra-price')[i].value || 0) })),
        features: Array.from(col.querySelectorAll('.plan-extras .feat-chk:checked')).map(i => i.dataset.feature)
      }));
      return {
        title: valOrDefault(titleEl.value),
        category: valOrDefault(categoryEl.value),
        subcategory: valOrDefault(subcatEl.value),
        tags: tagsEl.value.split(',').map(t => t.trim()).filter(Boolean),
        skills: skillsEl.value.split(',').map(s => s.trim()).filter(Boolean),
        languages: languagesEl.value.split(',').map(l => l.trim()).filter(Boolean),
        platform: valOrDefault(platformEl.value),
        delivery: valOrDefault(deliveryEl.value),
        plans,
        description: valOrDefault(quill.root.innerHTML),
        requirements: Array.from($$('.req-q')).map(i => i.value || 'Not Provided'),
        faq: Array.from($$('.faq-q')).map((q, i) => ({ q: q.value || 'Not Provided', a: $$('.faq-a')[i]?.value || 'Not Provided' })),
        images: imageUrls.length ? imageUrls : ['https://via.placeholder.com/1200x800.png?text=Talent-Hub+Gig'],
        sellerName: currentUser?.displayName || (currentUser?.email ? currentUser.email.split('@')[0] : 'Freelancer'),
        sellerPhoto: currentUser?.photoURL || '',
        status,
        createdByUid: currentUser?.uid || '',
        createdByEmail: currentUser?.email || '',
        rating: 0, reviews: 0,
        createdAt: serverTimestamp(), updatedAt: serverTimestamp()
      };
    }

    // Upload files with progress
    async function uploadFiles(files, uid, onProgress) {
      const urls = [];
      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        try {
          const path = `gigs/${uid}/${Date.now()}_${i}_${f.name.replace(/[^a-z0-9\\.\\-\\_]/gi, '')}`;
          const ref = storageRef(storage, path);
          const task = uploadBytesResumable(ref, f);
          await new Promise((res, rej) => {
            task.on('state_changed', snap => {
              const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
              onProgress && onProgress({ index: i, pct, name: f.name });
            }, err => { console.error('upload err', err); rej(err); }, async () => {
              const url = await getDownloadURL(task.snapshot.ref);
              urls.push(url); res();
            });
          });
        } catch (e) { console.error('file upload failed', e); }
      }
      return urls;
    }

    // Save Draft
    $('#btnSaveDraft').addEventListener('click', async () => {
      if (!currentUser) { alert('Please login to save draft to server. Local autosave is available.'); return; }
      btnSaveDraft.disabled = true; formStatus.textContent = 'Saving draft...';
      try {
        const urls = mediaFiles.length ? await uploadFiles(mediaFiles, currentUser.uid, ({ index, pct, name }) => formStatus.textContent = `Uploading ${name} ${pct}%`) : [];
        const payload = buildGigPayload('draft', urls);
        const ref = await addDoc(collection(db, GIGS_COLLECTION), payload);
        formStatus.textContent = 'Draft saved ✓';
        debugJson.textContent = JSON.stringify({ draftId: ref.id, payload }, null, 2);
      } catch (e) { formStatus.textContent = 'Save draft failed: ' + (e.message || e); }
      finally { btnSaveDraft.disabled = false; }
    });

    // Publish (allows blanks)
    $('#btnPublish').addEventListener('click', async () => {
      if (!currentUser) {
        if (!confirm('You are not logged in. Publish will not be saved to cloud. Continue and show final payload?')) return;
      }
      btnPublish.disabled = true; formStatus.textContent = 'Publishing...';
      try {
        const urls = currentUser && mediaFiles.length ? await uploadFiles(mediaFiles, currentUser.uid, ({ index, pct, name }) => formStatus.textContent = `Uploading ${name} ${pct}%`) : mediaFiles.map(f => f.name);
        const payload = buildGigPayload('published', urls);
        if (currentUser) {
          const ref = await addDoc(collection(db, GIGS_COLLECTION), payload);
          formStatus.textContent = 'Published ✓ Redirecting…'; debugJson.textContent = JSON.stringify({ id: ref.id, payload }, null, 2);
          setTimeout(() => location.href = `index.html?id=${encodeURIComponent(ref.id)}`, 700);
        } else {
          formStatus.textContent = 'Preview (not saved to server) — see JSON below'; debugJson.textContent = JSON.stringify({ previewPayload: payload }, null, 2);
        }
      } catch (e) { formStatus.textContent = 'Publish failed: ' + (e.message || e); }
      finally { btnPublish.disabled = false; }
    });

    // Reset
    $('#btnReset').addEventListener('click', () => { if (!confirm('Reset the entire form? This will clear autosaved draft locally.')) return; localStorage.removeItem(AUTOSAVE_KEY); location.reload(); });

    // Debug render
    function renderDebug() { debugJson.textContent = JSON.stringify(buildGigPayload('preview', mediaFiles.map(f => f.name)), null, 2); }

    // restore autosave on load
    window.addEventListener('load', () => { restoreAutosave(); renderPreview(); computeKeywordsAndScore(); renderDebug(); });

    // small helpers to react to changes in plan extras and features -> preview + autosave
    document.addEventListener('change', (e) => { if (e.target.closest('.plan-column')) { renderPreview(); autosaveNow('plan-change'); } });
    document.addEventListener('input', (e) => { if (e.target.closest('.plan-column')) { renderPreview(); autosaveNow('plan-input'); } });

  </script>
</body>

</html>
